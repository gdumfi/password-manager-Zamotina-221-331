# Password Manager — Zamotina 221-331

Лабораторная работа 1 по дисциплине «Разработка и эксплуатация автоматизированных систем в защищенном исполнении».

**Цель:** реализация защиты приложения Windows от утечек данных, отладки и модификации.

**Задача:** разработка приложения для безопасного хранения учетных данных (URL, логин, пароль) с шифрованием AES-256 и комплексной защитой от кражи данных, атак с использованием отладки и модификации исполняемого модуля.

## Структура проекта

```
password-manager-Zamotina-221-331/
├── password-manager-Zamotina-221-331/   # Менеджер паролей (Qt 6 + OpenSSL)
│   ├── main.cpp                         # Точка входа, защита от отладки и контрольная сумма
│   ├── mainwindow.h / .cpp              # Окно аутентификации (ввод пин-кода)
│   ├── vaultwindow.h / .cpp             # Окно хранилища (таблица учетных данных)
│   ├── credentialsmodel.h / .cpp        # Модель данных для таблицы
│   ├── credential.h                     # Структура учетной записи (URL, логин, пароль)
│   ├── vaultrepository.h / .cpp         # Шифрование/дешифрование хранилища (AES-256)
│   └── CMakeLists.txt                   # Сборка проекта
├── debugger-protection/                 # Приложение-спутник (антиотладка)
│   └── debugger-protection.cpp          # Самоотладка через DebugActiveProcess()
└── README.md
```

## Скриншоты

<!-- Вставьте скриншоты в папку screenshots/ и раскомментируйте строки ниже -->
<!-- ![Окно аутентификации](screenshots/auth.png) -->
<!-- ![Окно хранилища с фильтрацией](screenshots/vault.png) -->

## Этап 1: Базовое приложение

### Окно аутентификации
- Ввод пин-кода для разблокировки хранилища
- Блокировка интерфейса при неверном пин-коде

### Окно хранилища учетных данных
- Отображение учетных данных в таблице (URL, логин, пароль)
- Логины и пароли **маскированы** символами `*` по умолчанию
- Кнопка для раскрытия/скрытия данных
- Фильтрация записей по URL
- Адаптивный интерфейс, подстраивающийся под изменение размера окна

## Этап 2: Реализация защиты

### 1. Шифрование данных (AES-256)

Файл с учетными данными (`credentials.json`) зашифрован алгоритмом **AES-256-CBC** через библиотеку OpenSSL. Пин-код преобразуется в ключ шифрования. Логины и пароли дополнительно зашифрованы в оперативной памяти — в структуре `Credential` хранится поле `secretB64` (зашифрованный base64-блоб), а не открытые значения.

- `VaultRepository::pinToKey()` — преобразование пин-кода в 256-битный ключ
- `VaultRepository::aesEncrypt()` / `aesDecrypt()` — шифрование/дешифрование данных
- `VaultRepository::encryptSecretToB64()` / `decryptSecretFromB64()` — шифрование пар логин/пароль

### 2. Защита от отладки: IsDebuggerPresent()

При запуске приложение вызывает WinAPI-функцию `IsDebuggerPresent()`. Если обнаружен подключённый отладчик — отображается предупреждение и приложение завершается **до ввода пин-кода**.

**Файл:** `main.cpp`, функция `checkForDebugger()`

```cpp
if (IsDebuggerPresent()) {
    QMessageBox::critical(nullptr, "Ошибка безопасности",
                          "Обнаружен отладчик. Программа не может быть запущена.");
    return true;
}
```

### 3. Защита от отладки: Самоотладка (приложение-спутник)

Приложение-спутник `debugger-protection` реализует метод «самоотладки»:

1. **`CreateProcessW()`** — запускает менеджер паролей в отдельном процессе
2. **`DebugActiveProcess()`** — подключается к процессу как отладчик
3. **`WaitForDebugEvent()` + `ContinueDebugEvent()`** — обрабатывает отладочные события в цикле

Поскольку к процессу Windows может быть подключён **только один отладчик**, внешний отладчик (x64dbg, WinDbg) не сможет подключиться к менеджеру паролей, пока к нему привязан спутник.

**Файл:** `debugger-protection/debugger-protection.cpp`

### 4. Защита от модификации: контрольная сумма .text

При каждом запуске приложение проверяет целостность своего исполняемого модуля:

1. Определяет **виртуальный адрес** начала сегмента `.text` через разбор PE-заголовков (DOS Header → NT Header → Section Headers)
2. Определяет **размер** сегмента `.text`
3. Читает секцию `.text` из файла на диске и вычисляет **SHA-256** хеш-сумму
4. Сравнивает вычисленную сумму с **эталонной**, зашитой в коде
5. Если суммы не совпадают — отображает предупреждение о модификации и завершает работу

Эталонный хеш хранится в секции `.rdata` (константные данные), поэтому его изменение в исходном коде не влияет на содержимое `.text`.

**Файл:** `main.cpp`, функция `verifyTextSectionSha256()`

## Сборка и запуск

### Требования

- **Qt** 6.10.2 (MinGW 64-bit)
- **OpenSSL** 3.x (входит в комплект Qt)
- **CMake** 3.16+
- **Visual Studio** (для сборки приложения-спутника)

### Сборка менеджера паролей

1. Открыть `password-manager-Zamotina-221-331/CMakeLists.txt` в Qt Creator
2. Выбрать комплект сборки Desktop Qt 6.10.2 MinGW 64-bit
3. Собрать проект (Ctrl+B)

### Получение эталонного хеша .text

1. Собрать проект с нулевым хешем в `main.cpp`
2. Запустить приложение, скопировать хеш из вывода `qDebug`
3. Вставить хеш в переменную `referenceHash` в `main.cpp`
4. Пересобрать проект — хеш `.text` не изменится, т.к. строка хранится в `.rdata`

### Сборка приложения-спутника

1. Открыть `debugger-protection/debugger-protection.sln` в Visual Studio
2. Собрать проект (Ctrl+Shift+B)

### Запуск под защитой антиотладчика

```
debugger-protection.exe
```

Спутник автоматически запустит менеджер паролей и подключится к нему как отладчик.

### Развёртывание Qt-библиотек (для запуска вне Qt Creator)

```
C:\Qt\6.10.2\mingw_64\bin\windeployqt.exe <путь_к_каталогу_с_exe>
```

Дополнительно скопировать `libcrypto-3-x64.dll` и `libssl-3-x64.dll` из `C:\Qt\Tools\OpenSSLv3\Win_x64\bin` в каталог с менеджером паролей.

## Тестирование защиты

| Защита | Как проверить | Ожидаемый результат |
|--------|---------------|---------------------|
| `IsDebuggerPresent()` | Запустить менеджер паролей через отладку (F5 в Qt Creator) | Сообщение «Обнаружен отладчик», приложение завершается |
| Самоотладка | Запустить через спутник, затем попробовать подключить x64dbg | x64dbg не может подключиться к процессу |
| Контрольная сумма | Модифицировать .exe в hex-редакторе и запустить | Сообщение «Контрольная сумма не совпала» |

